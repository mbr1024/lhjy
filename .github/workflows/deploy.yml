name: Deploy to Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            
            # é¡¹ç›®ç›®å½•
            PROJECT_DIR=~/lhjy
            
            echo "=========================================="
            echo "  ğŸš€ å¼€å§‹éƒ¨ç½² LHJY"
            echo "=========================================="
            
            # 1. è¿›å…¥é¡¹ç›®ç›®å½•å¹¶æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ [1/5] æ‹‰å–æœ€æ–°ä»£ç ..."
            cd $PROJECT_DIR
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
            
            # 2. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "ğŸ›‘ [2/5] åœæ­¢æ—§å®¹å™¨..."
            docker stop lhjy-app || true
            docker rm lhjy-app || true
            echo "âœ… æ—§å®¹å™¨å·²æ¸…ç†"
            
            # 3. åˆ é™¤æ—§é•œåƒï¼ˆå¯é€‰ï¼ŒèŠ‚çœç©ºé—´ï¼‰
            echo "ğŸ§¹ [3/5] æ¸…ç†æ—§é•œåƒ..."
            docker rmi lhjy-app || true
            
            # 4. æ„å»ºæ–°é•œåƒ
            echo "ï¿½ [4/5] æ„å»º Docker é•œåƒ..."
            docker build -t lhjy-app .
            echo "âœ… é•œåƒæ„å»ºå®Œæˆ"
            
            # 5. å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ [5/5] å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name lhjy-app \
              --restart always \
              -p 80:3000 \
              -e SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY }} \
              -e HOSTNAME="0.0.0.0" \
              -e TURSO_DATABASE_URL=${{ secrets.TURSO_DATABASE_URL }} \
              -e TURSO_AUTH_TOKEN=${{ secrets.TURSO_AUTH_TOKEN }} \
              --health-cmd="curl -f http://localhost:3000 || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              lhjy-app
            
            # 6. ç­‰å¾…å¹¶éªŒè¯
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            if docker ps | grep -q lhjy-app; then
              echo "=========================================="
              echo "  âœ… éƒ¨ç½²æˆåŠŸï¼"
              echo "=========================================="
              docker ps --filter name=lhjy-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æŸ¥çœ‹æ—¥å¿—ï¼š"
              docker logs lhjy-app --tail 50
              exit 1
            fi
            
            # 7. æ¸…ç†æ— ç”¨é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ— ç”¨é•œåƒ..."
            docker image prune -f
            echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆ"
